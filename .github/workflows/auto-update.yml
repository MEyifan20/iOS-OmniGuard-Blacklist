name: ğŸš€ æ•é£Ÿè€…è‡ªåŠ¨åŒ–æ„å»º | Predator Auto Build

on:
  push:
    paths:
      - 'iOS-OmniGuard-Blacklist.txt' # ä»…å½“ä¸»è§„åˆ™æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸åœ¨ GitHub ç•Œé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

# èµ‹äºˆ Action å†™å…¥æƒé™ï¼Œç¡®ä¿èƒ½æ¨é€ä¿®æ”¹åçš„æ–‡æ¡£
permissions:
  contents: write

jobs:
  build-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç  (Checkout Repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç¡®ä¿ git show å¯¹æ¯”é€»è¾‘æ­£å¸¸
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ› ï¸ è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬ (Run Update Script)
        # è¯¥è„šæœ¬ä¼šåŒæ—¶åˆ·æ–° .txt, changelog.md å’Œ README.md
        run: python scripts/update_rules.py

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€å˜åŠ¨ (Commit and Push Changes)
        run: |
          # é…ç½®æœºå™¨äººèº«ä»½
          git config --local user.email "action@github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¿…é¡»åŒ…å« README.mdï¼Œå¦åˆ™æ—¶é—´æ°¸è¿œä¸ä¼šåœ¨ GitHub ä¸Šæ›´æ–°
          git add iOS-OmniGuard-Blacklist.txt changelog.md README.md
          
          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŠ¨ï¼Œé¿å…ç©ºæäº¤å¯¼è‡´ Action æŠ¥é”™
          if git diff --staged --quiet; then
            echo "âœ… æ‰€æœ‰æ–‡æ¡£å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æäº¤ã€‚"
          else
            # ä½¿ç”¨ [skip ci] æ ‡è®°é˜²æ­¢æœºå™¨äººæ¨é€è§¦å‘æ­»å¾ªç¯
            git commit -m "chore: è‡ªåŠ¨åŒ–åˆ·æ–°å…¨é‡æ–‡æ¡£ç‰ˆæœ¬åŠæ—¶é—´ [skip ci]"
            git push
          fi
